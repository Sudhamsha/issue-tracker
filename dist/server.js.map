{"version":3,"sources":["../server/server.js"],"names":["install","app","use","static","json","secret","resave","saveUninitialized","process","env","NODE_ENV","webpack","require","webpackDevMiddleware","webpackHotMiddleware","config","entry","push","plugins","HotModuleReplacementPlugin","bundler","noInfo","log","console","db","connect","then","connection","listen","catch","error","all","req","res","next","method","session","user","status","send","message","get","signedIn","name","post","body","id_token","code","response","ok","Promise","reject","data","given_name","destroy","filter","query","effort_lte","effort_gte","effort","$lte","parseInt","$gte","search","$text","$search","_summary","undefined","limit","_limit","offset","_offset","cursor","collection","find","sort","_id","skip","totalCount","count","result","toArray","issues","metadata","records","aggregate","$match","$group","owner","$sum","results","stats","forEach","issueId","ObjectId","ObjectID","params","id","issue","newIssue","created","Date","err","validateIssue","insertOne","cleanupIssue","insertedId","put","update","convertIssue","savedIssue","delete","deleteOne","deleteRequest","n","sendFile","resolve"],"mappings":"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","file":"server.js","sourcesContent":["\nimport express from 'express';\nimport bodyParser from 'body-parser';\nimport { MongoClient } from 'mongodb';\nimport 'babel-polyfill';\nimport SourceMapSupport from 'source-map-support';\nimport Issue from './issue';\nimport path from 'path';\nimport fetch from 'node-fetch';\nimport session from 'express-session';\n\nSourceMapSupport.install();\n\nconst app = express();\napp.use(express.static('public'));\napp.use(bodyParser.json());\n\napp.use(session({ secret: 'h7e3f5s6', resave: false, saveUninitialized:\ntrue }));\n\n\nif (process.env.NODE_ENV !== 'production') {\n  const webpack = require('webpack'); // eslint-disable-line\n  const webpackDevMiddleware = require('webpack-dev-middleware'); // eslint-disable-line\n  const webpackHotMiddleware = require('webpack-hot-middleware'); // eslint-disable-line\n\n  const config = require('../webpack.config'); // eslint-disable-line\n  config.entry.app.push('webpack-hot-middleware/client', 'webpack/hot/only-dev-server');\n  config.plugins.push(new webpack.HotModuleReplacementPlugin());\n\n  const bundler = webpack(config);\n  app.use(webpackDevMiddleware(bundler, { noInfo: true }));\n  app.use(webpackHotMiddleware(bundler, { log: console.log }));\n}\n\nlet db;\nMongoClient.connect('mongodb://localhost/issuetracker').then((connection) => {\n  db = connection;\n  app.listen(8000, () => {\n    console.log('App started on 8000');\n  });\n}).catch((error) => {\n  console.log('ERROR', error);\n});\n\n// Check User\napp.all('/api/*', (req, res, next) => {\n    if (req.method === 'DELETE' || req.method === 'POST' || req.method ===\n    'PUT') {\n        if (!req.session || !req.session.user) {\n            res.status(403).send({\n                message: 'You are not authorized to perform the operation',\n            });\n        } else {\n            next();\n        }\n    } else {\n        next();\n    }\n});\n\napp.get('/api/users/me', (req, res) => {\n    if (req.session && req.session.user) {\n        res.json(req.session.user);\n    } else {\n        res.json({ signedIn: false, name: '' });\n    }\n});\n\napp.post('/signin', (req, res) => {\n    if (!req.body.id_token) {\n        res.status(400).send({ code: 400, message: 'Missing Token.' });\n        return;\n    }\n    fetch(`https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=${req.body.\n        id_token}`)\n        .then(response => {\n            if (!response.ok) response.json().then(error => Promise.reject(error));\n            response.json().then(data => {\n                req.session.user = {\n                    signedIn: true, name: data.given_name,\n                };\n                res.json(req.session.user);\n            });\n        })\n        .catch(error => {\n            console.log(error);\n            res.status(500).json({ message: `Internal Server Error: ${error}` });\n        });\n});\n\napp.post('/signout', (req, res) => {\n    if (req.session) req.session.destroy();\n    res.json({ status: 'ok' });\n});\n\n// Get Issues\napp.get('/api/issues', (req, res) => {\n  const filter = {};\n  if (req.query.status) {\n    filter.status = req.query.status;\n  }\n\n  if (req.query.effort_lte || req.query.effort_gte) {\n    filter.effort = {};\n  }\n\n  if (req.query.effort_lte) {\n    filter.effort.$lte = parseInt(req.query.effort_lte, 10);\n  }\n\n  if (req.query.effort_gte) {\n    filter.effort.$gte = parseInt(req.query.effort_gte, 10);\n  }\n\n  if (req.query.search) filter.$text = { $search: req.query.search };\n\n  if(req.query._summary === undefined) {\n      let limit = req.query._limit ? parseInt(req.query._limit, 10) : 20;\n      const offset = req.query._offset ? parseInt(req.query._offset, 10) : 0;\n      if (limit > 50) limit = 50;\n\n      const cursor = db.collection('issues').find(filter).sort({ _id: 1 })\n          .skip(offset)\n          .limit(limit);\n          let totalCount;\n          cursor.count(false).then(result => {\n              totalCount = result;\n              return cursor.toArray();\n          })\n          .then((issues) => {\n              res.json({ metadata: { totalCount }, records: issues });\n      })\n          .catch((error) => {\n              console.log('ERROR', error);\n              res.status(500).json({ message: `Internal Server Error: ${error}` });\n          });\n  }\n  else {\n    db.collection('issues').aggregate([\n        { $match: filter },\n        { $group: { _id: { owner: '$owner', status: '$status' }, count: {\n        $sum: 1 } } },\n        ]).toArray()\n        .then(results => {\n            const stats = {};\n            results.forEach(result => {\n                if (!stats[result._id.owner]) stats[result._id.owner] = {};\n                stats[result._id.owner][result._id.status] = result.count;\n            });\n            res.json(stats);\n        })\n        .catch(error => {\n            console.log(error);\n            res.status(500).json({ message: `Internal Server Error: ${error}` });\n        });\n  }\n\n});\n\n// Get Single Issue\napp.get('/api/issues/:id', (req, res) => {\n  let issueId;\n  try {\n    const ObjectId = require('mongodb').ObjectID;\n    issueId = ObjectId(req.params.id);\n  } catch (error) {\n    res.status(422).json({ message: `Invalid issue ID format: ${error}` });\n    return;\n  }\n  db.collection('issues').find({ _id: issueId }).limit(1)\n    .next()\n    .then(issue => {\n      if (!issue) res.status(404).json({ message: `No issue found with ID: ${issueId}` });\n      else res.json(issue);\n    })\n    .catch(error => {\n      res.status(500).json({ message: `Internal Server Error: ${error}`});\n    });\n  });\n\n// Post Issue\napp.post('/api/issues', (req, res) => {\n  const newIssue = req.body;\n  newIssue.created = new Date();\n  if (!newIssue.status) {\n    newIssue.status = 'New';\n  }\n\n  const err = Issue.validateIssue(newIssue);\n  if (err) {\n    res.status(422).json({ message: `Invalid request: ${err}` });\n    return;\n  }\n\n  db.collection('issues').insertOne(Issue.cleanupIssue(newIssue)).then(result =>\n    db.collection('issues').find({ _id: result.insertedId }).limit(1).next(),\n  ).then((newIssue) => {\n    res.json(newIssue);\n  })\n    .catch((error) => {\n      console.log('ERROR', error);\n      res.status(500).json({ message: `Internal Server Error: ${error}` });\n    });\n});\n\n// Update Issue\napp.put('/api/issues/:id', (req, res) => {\n  let issueId;\n  try {\n    const ObjectId = require('mongodb').ObjectID;\n    issueId = ObjectId(req.params.id);\n  } catch (error) {\n    res.status(422).json({ message: `Invalid issue ID format: ${error}` });\n    return;\n  }\n\n  const issue = req.body;\n  delete issue._id;\n\n  const err = Issue.validateIssue(issue);\n  if (err) {\n    res.status(422).json({ message: `Invalid request: ${err}` });\n  }\n  db.collection('issues').update({ _id: issueId },\n    Issue.convertIssue(issue)).then(() =>\n    db.collection('issues').find({ _id: issueId }).limit(1)\n      .next()\n  )\n    .then(savedIssue => {\n      res.json(savedIssue);\n    })\n    .catch(error => {\n      console.log(error);\n      res.status(500).json({ message: `Internal Server Error: ${error}` });\n    });\n});\n\napp.delete('/api/issues/:id', (req, res) => {\n  let issueId;\n  try {\n    const ObjectId = require('mongodb').ObjectID;\n    issueId = ObjectId(req.params.id);\n  } catch (error) {\n    res.status(422).json({ message: `Invalid issue ID format: ${error}` });\n    return;\n  }\n\n  db.collection('issues').deleteOne({ _id: issueId }).then((deleteRequest) => {\n    if (deleteRequest.result.n === 1) res.json({ status: 'OK' });\n    else res.json({ status: 'Warning: object not found' });\n  })\n    .catch(error => {\n      console.log(error);\n      res.status(500).json({ message: `Internal Server Error: ${error}` });\n    });\n});\n\napp.get('*', (req, res) => {\n  res.sendFile(path.resolve('public/index.html'));\n});\n"]}